<div class="container py-4 py-md-5" data-controller="auction-claim auction-buy">

  <!-- Header -->
  <div class="mb-3 mb-md-4">
    <h1 class="h3 page-title mb-1">Active Auctions</h1>
    <p class="page-subtitle mb-0">Browse all active ENS domain auctions. Sellers can claim back expired auctions.</p>
  </div>

  <!-- Filters + Search -->
  <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-3">
    <!-- Status filters -->
    <div class="filters d-flex flex-wrap align-items-center chip-group" role="group" aria-label="Status filters">
      <%= link_to auctions_path, class: "btn btn-outline-light me-2 #{'active' unless params[:status]}" do %>
        Show All
      <% end %>
      <%= link_to auctions_path(status: 'active'), class: "btn btn-outline-light me-2 #{'active' if params[:status] == 'active'}" do %>
        Active
      <% end %>
      <%= link_to auctions_path(status: 'expired'), class: "btn btn-outline-light me-2 #{'active' if params[:status] == 'expired'}" do %>
        Expired
      <% end %>
      <%= link_to auctions_path(status: 'settled'), class: "btn btn-outline-light #{'active' if params[:status] == 'settled'}" do %>
        Settled
      <% end %>
    </div>

    <!-- Free text search -->
    <div class="search-wrap position-relative w-100 w-lg-auto" style="max-width:420px;">
      <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M11 19a8 8 0 1 1 5.292-13.708A8 8 0 0 1 11 19Zm10 2-5.4-5.4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <%= form_with url: auctions_path, method: :get, local: false, class: "d-flex" do |form| %>
        <%= form.text_field :search, value: params[:search], class: "form-control", placeholder: "Search domainsâ€¦", aria: { label: "Search domains" } %>
        <%= form.hidden_field :status, value: params[:status] if params[:status] %>
      <% end %>
    </div>
  </div>

  <!-- Table Card -->
  <div class="card shadow-soft">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th scope="col">Domain</th>
            <th scope="col">Starting Price</th>
            <th scope="col">Current Price</th>
            <th scope="col">Expires</th>
            <th scope="col">Status</th>
            <th scope="col" class="text-end">Action</th>
          </tr>
        </thead>
        <tbody>
          <% @auctions.each do |auction| %>
            <% 
              start_time = Time.at(auction.start_time.to_i)
              end_time = start_time + auction.duration_days.to_i.days
              is_expired = Time.current > end_time
            %>
            <tr data-auction-id="<%= auction.id %>" 
                data-contract-address="<%= auction.contract_address %>"
                data-nft-address="<%= auction.nft_address %>" 
                data-token-id="<%= auction.token_id %>"
                data-seller="<%= auction.seller %>"
                data-expired="<%= is_expired %>"
                data-settled="<%= auction.settled %>">
              <td class="name-cell">
                <%= link_to auction_path(auction) do %>
                  <%= auction.domain_name %>
                <% end %>
              </td>
              <td class="price-cell">
                $<%= number_with_precision(auction.start_price_usd.to_f / 1e18, precision: 2) %>
              </td>
              <td class="current-price-cell" data-auction-buy-target="currentPrice" data-nft-address="<%= auction.nft_address %>" data-token-id="<%= auction.token_id %>" data-contract-address="<%= auction.contract_address %>">
                <% if auction.settled? %>
                  <%= number_with_precision(auction.sale_price_eth.to_f / 1e18, precision: 4) %> ETH
                <% elsif is_expired %>
                  <span class="text-muted">Expired</span>
                <% else %>
                  <span class="text-muted"><%= number_to_currency(auction.current_price_usd.to_f, precision: 2) %></span>
                <% end %>
              </td>
              <td class="expiry-cell">
                <%= end_time.strftime("%Y-%m-%d %H:%M") %> UTC
              </td>
              <td class="status-cell">
                <% if auction.settled? %>
                  <span class="badge bg-success">Sold</span>
                <% elsif is_expired %>
                  <span class="badge bg-warning">Expired</span>
                <% else %>
                  <span class="badge bg-primary">Active</span>
                <% end %>
              </td>
              <td class="text-end">
                <% if auction.settled? %>
                  <span class="text-muted small">Completed</span>
                <% elsif is_expired %>
                  <button class="btn btn-outline-danger btn-sm" 
                          data-auction-claim-target="claimButton"
                          data-action="click->auction-claim#claimBack"
                          data-nft-address="<%= auction.nft_address %>"
                          data-token-id="<%= auction.token_id %>"
                          data-contract-address="<%= auction.contract_address %>"
                          data-show-to-wallet="<%= auction.seller %>"
                          data-auction-id="<%= auction.id %>">
                    Claim Back
                  </button>
                <% else %>
                  <div class="d-flex gap-2">
                    <button class="btn btn-success btn-sm" 
                            data-auction-buy-target="buyButton"
                            data-action="click->auction-buy#buy"
                            data-nft-address="<%= auction.nft_address %>"
                            data-token-id="<%= auction.token_id %>"
                            data-contract-address="<%= auction.contract_address %>"
                            data-auction-id="<%= auction.id %>"
                            data-show-to-wallet="any"
                            data-seller="<%= auction.seller %>">
                      Buy Now
                    </button>
                    <%= link_to "View Details", auction_path(auction), class: "btn btn-outline-primary btn-sm" %>
                  </div>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

</div>